name: Checks

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  verify-files:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: Verify required files
        run: |
          set -euo pipefail
          if [ ! -f README.md ]; then
            echo "README.md is missing"
            exit 1
          fi
          if [ ! -d ".version" ]; then
            echo ".version directory is missing"
            exit 1
          fi
          echo "All required files are present."

  lint-scripts:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: Run shellcheck on install.sh
        run: |
          set -euo pipefail
          if [ -f install.sh ]; then
            shellcheck -e SC1090,SC2086,SC2024,SC2164 install.sh || {
              echo "Shellcheck failed for install.sh"
              exit 1
            }
            echo "install.sh passed shellcheck."
          else
            echo "install.sh not found, skipping."
          fi

  validate-configs:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: Validate config files in dotfiles
        run: |
          set -euo pipefail
          find dotfiles -type f \( -name "*.conf" -o -name "*.yml" -o -name "*.json" \) | while read -r file; do
            case "$file" in
              *.json)
                sed -E '/^\s*\/\//d; s/\/\*.*\*\///' "$file" | jq empty || {
                  echo "JSON validation failed for $file"
                  exit 1
                }
                echo "Valid JSON: $file"
                ;;
              *.yml)
                yamllint "$file" || {
                  echo "YAML validation failed for $file"
                  exit 1
                }
                echo "Valid YAML: $file"
                ;;
              *.conf)
                echo "Checked $file (assumed valid)."
                ;;
            esac
          done
