validate-configs:
  runs-on: ${{ matrix.os }}
  strategy:
    matrix:
      os: [ubuntu-20.04, ubuntu-22.04]
  steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.x"

    - name: Cache pip
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        set -euo pipefail
        pip install --upgrade pip
        pip install yamllint jq

    - name: Validate config files in dotfiles
      run: |
        set -euo pipefail
        find dotfiles -type f \( -name "*.conf" -o -name "*.yml" -o -name "*.json" \) | while read -r file; do
          case "$file" in
            *.json)
              sed -E '/^\s*\/\//d; s/\/\*.*\*\///' "$file" | jq empty || {
                echo "JSON validation failed for $file"
                exit 1
              }
              echo "Valid JSON: $file"
              ;;
            *.yml)
              yamllint "$file" || {
                echo "YAML validation failed for $file"
                exit 1
              }
              echo "Valid YAML: $file"
              ;;
            *.conf)
              echo "Checked $file (assumed valid)."
              ;;
          esac
        done
